<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Group Chat - ChatApp</title>
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Socket.io Client Library (integrity removed to avoid SRI issues) -->
  <script src="https://cdn.socket.io/4.5.1/socket.io.min.js" crossorigin="anonymous"></script>
</head>
<body class="bg-gray-100">
  <!-- Navigation Bar -->
  <nav class="bg-white shadow px-4 py-3 flex items-center justify-between">
    <div class="flex items-center">
      <span class="text-xl font-bold text-gray-800">ChatApp Group Chat</span>
    </div>
    <div>
      <button id="logoutBtn" class="text-gray-600 hover:text-gray-800">Logout</button>
    </div>
  </nav>

  <!-- Main Container: Sidebar (group list) and Chat Area -->
  <div class="flex h-[calc(100vh-64px)]">
    <!-- Sidebar -->
    <aside class="w-1/4 border-r border-gray-300 p-4">
      <div class="mb-4">
        <h2 class="text-lg font-bold">Your Groups</h2>
      </div>
      <ul id="groupList" class="space-y-2">
        <!-- Groups will be loaded here -->
      </ul>
      <button id="createGroupBtn" class="mt-4 w-full bg-blue-500 text-white py-2 rounded">Create Group</button>
      <button id="inviteBtn" class="mt-2 w-full bg-green-500 text-white py-2 rounded">Invite Member</button>
    </aside>

    <!-- Chat Area -->
    <main class="flex-1 flex flex-col">
      <!-- Chat Header -->
      <header id="chatHeader" class="p-4 border-b border-gray-300">
        <h2 id="chatGroupName" class="text-xl font-bold">Select a Group</h2>
      </header>
      <!-- Message List -->
      <div id="chatMessages" class="flex-1 p-4 overflow-y-auto">
        <!-- Messages will appear here -->
      </div>
      <!-- Message Input -->
      <footer class="p-4 border-t border-gray-300">
        <form id="messageForm" class="flex">
          <input type="text" id="messageInput" placeholder="Type your message..." class="flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none" required>
          <button type="submit" class="ml-4 bg-blue-500 text-white py-2 px-4 rounded-full">Send</button>
        </form>
      </footer>
    </main>
  </div>

  <!-- Invite Member Modal -->
  <div id="inviteModal" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 hidden">
    <div class="bg-white p-6 rounded shadow-md w-1/3">
      <h3 class="text-lg font-bold mb-4">Invite Member</h3>
      <form id="inviteForm">
        <div class="mb-4">
          <label for="inviteEmail" class="block text-gray-700">User Email:</label>
          <input type="email" id="inviteEmail" name="inviteEmail" placeholder="friend@example.com" class="w-full border border-gray-300 rounded px-3 py-2" required>
        </div>
        <div class="flex justify-end">
          <button type="submit" class="bg-green-500 text-white py-2 px-4 rounded">Invite</button>
          <button type="button" id="closeInviteModal" class="ml-2 bg-gray-500 text-white py-2 px-4 rounded">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // --- Session Check ---
    if (!localStorage.getItem("token") || !localStorage.getItem("userId")) {
      window.location.href = "/login.html";
    }
    const token = localStorage.getItem("token");
    const userId = parseInt(localStorage.getItem("userId"), 10);
    let currentGroupId = null; // Will be set when a group is selected.
    console.log("Logged in as user:", userId);

    // --- Socket.io Setup ---
    const socket = io();
    
    // --- Load Groups ---
    async function loadGroups() {
      try {
        // GET /groups?userId=...
        const response = await fetch(`/groups?userId=${userId}`);
        const data = await response.json();
        console.log("Loaded groups:", data);
        const groupList = document.getElementById("groupList");
        groupList.innerHTML = "";
        if (data.groups && data.groups.length > 0) {
          data.groups.forEach(group => {
            const li = document.createElement("li");
            li.textContent = group.name;
            li.dataset.groupId = group.id;
            li.className = "cursor-pointer p-2 hover:bg-gray-200 rounded";
            li.addEventListener("click", () => selectGroup(group.id, group.name));
            groupList.appendChild(li);
          });
        } else {
          groupList.innerHTML = "<li>No groups found.</li>";
        }
      } catch (err) {
        console.error("Error loading groups:", err);
      }
    }
    
    function selectGroup(groupId, groupName) {
      currentGroupId = groupId;
      document.getElementById("chatGroupName").textContent = groupName;
      // Join the group room via Socket.io.
      socket.emit("joinGroup", groupId);
      loadGroupMessages(groupId);
    }
    
    // --- Load Group Messages ---
    async function loadGroupMessages(groupId) {
      try {
        // GET /groups/:groupId/messages
        const response = await fetch(`/groups/${groupId}/messages`);
        const data = await response.json();
        console.log("Loaded messages for group", groupId, ":", data);
        renderMessages(data.messages || []);
      } catch (err) {
        console.error("Error loading messages:", err);
      }
    }
    
    function renderMessages(messages) {
      const chatMessages = document.getElementById("chatMessages");
      chatMessages.innerHTML = "";
      messages.forEach(msg => {
        const isSender = msg.senderId === userId;
        const msgDiv = document.createElement("div");
        msgDiv.className = isSender ? "flex justify-end mb-2" : "flex justify-start mb-2";
        const bubble = document.createElement("div");
        bubble.className = isSender
          ? "bg-blue-500 text-white px-4 py-2 rounded-lg max-w-md"
          : "bg-gray-300 text-gray-800 px-4 py-2 rounded-lg max-w-md";
        bubble.textContent = msg.message;
        msgDiv.appendChild(bubble);
        chatMessages.appendChild(msgDiv);
      });
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // --- Sending Messages ---
    document.getElementById("messageForm").addEventListener("submit", (e) => {
      e.preventDefault();
      if (!currentGroupId) {
        alert("Please select a group first.");
        return;
      }
      const input = document.getElementById("messageInput");
      const messageText = input.value.trim();
      if (!messageText) return;
      input.value = "";
      const newMsg = {
        senderId: userId,
        groupId: currentGroupId,
        message: messageText,
        createdAt: new Date().toISOString()
      };
      console.log("Sending message:", newMsg);
      socket.emit("sendGroupMessage", newMsg);
    });
    
    // --- Socket.io: New Group Message Listener ---
    socket.on("newGroupMessage", (message) => {
      console.log("Received new group message:", message);
      // If the message belongs to the currently selected group, reload messages.
      if (currentGroupId && message.groupId === currentGroupId) {
        loadGroupMessages(currentGroupId);
      }
    });
    
    // --- Logout Functionality ---
    document.getElementById("logoutBtn").addEventListener("click", () => {
      console.log("Logout button clicked.");
      localStorage.clear();
      window.location.href = "/login.html";
    });
    
    // --- Invite Modal Handling ---
    const inviteModal = document.getElementById("inviteModal");
    const inviteBtn = document.getElementById("inviteBtn");
    const closeInviteModal = document.getElementById("closeInviteModal");
    const inviteForm = document.getElementById("inviteForm");
    
    inviteBtn.addEventListener("click", () => {
      if (!currentGroupId) {
        alert("Please select a group first.");
        return;
      }
      inviteModal.classList.remove("hidden");
    });
    
    closeInviteModal.addEventListener("click", () => {
      inviteModal.classList.add("hidden");
    });
    
    inviteForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const inviteEmail = document.getElementById("inviteEmail").value.trim();
      if (!inviteEmail) {
        alert("Please enter an email address.");
        return;
      }
      try {
        const response = await fetch(`/groups/${currentGroupId}/invite`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: inviteEmail })
        });
        const data = await response.json();
        console.log("Invite response:", data);
        if (response.ok) {
          alert("User invited successfully.");
          inviteForm.reset();
          inviteModal.classList.add("hidden");
          loadGroups(); // Reload groups if necessary.
        } else {
          alert(data.message || "Failed to invite user.");
        }
      } catch (err) {
        console.error("Error inviting user:", err);
        alert("Error inviting user. Please try again.");
      }
    });
    
    // --- Initial Load ---
    window.addEventListener("load", () => {
      loadGroups();
    });
  </script>
</body>
</html>
